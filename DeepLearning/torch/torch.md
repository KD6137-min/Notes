# torch

torchåº“ä¸“æ³¨äºåŸºç¡€å¼ é‡æ“ä½œå’Œè‡ªåŠ¨å¾®åˆ†æœºåˆ¶

# ä¸€. æ ¸å¿ƒå¼ é‡æ“ä½œ

## åˆ›é€ ä¸è½¬æ¢

ç±»å‹è½¬æ¢ï¼š`tensor.type(dtype)`â€‹æ–¹æ³•ï¼Œä¸æ˜¯`type()`â€‹å†…ç½®å‡½æ•°

æ¯”è¾ƒæŠ€å·§

```python
# å°†y_hatè½¬ä¸ºå’ŒyåŒç±»å‹åæ¯”è¾ƒï¼Œå¦åˆ™æ•°æ®ç›¸åŒç±»å‹ä¸åŒä»ä¸ºFalse
cmp = y_hat.type(y.dtype) == y
```

.numpy()å’Œ.to\_numpy()åŒºåˆ«ï¼š

- .numpy()å±äºPyTorchçš„`Tensor`â€‹å¯¹è±¡æ–¹æ³•ï¼Œå…±äº«å†…å­˜
- .to\_numpy()å±äºPandasçš„`DataFrame`â€‹æˆ–`Series`â€‹å¯¹è±¡æ–¹æ³•ï¼Œé»˜è®¤ä¸å…±äº«å†…å­˜ï¼Œå¯é€šè¿‡copyå‚æ•°æ§åˆ¶

ä¸¤ä¸ªæ ¸å¿ƒç±»å‹ï¼šPILå›¾åƒå¯¹è±¡å’ŒPyTorchå¼ é‡

- PyTorchå¼ é‡ï¼šé€šé“ä¼˜å…ˆ`[C, H, W]`ï¼Œæ•°å€¼èŒƒå›´é€šå¸¸ä¸º`[0, 1]`æˆ–æ ‡å‡†åŒ–åçš„æµ®ç‚¹æ•°ï¼Œ`matplotlib`çš„`imshow()`æ— æ³•ç›´æ¥è¯†åˆ«å…¶æ•°æ®ç»“æ„ï¼Œéœ€è½¬ä¸ºNumPyæ•°ç»„ï¼ˆ`[H, W, C]`ï¼‰å¹¶è‡ªåŠ¨æ˜ å°„åˆ°`[0, 255]`æ•´æ•°èŒƒå›´
- PILå›¾åƒï¼šé€šé“æœ€å`[H, W, C]`æ’åˆ—åƒç´ å€¼ï¼ˆèŒƒå›´`[0, 255]`ï¼‰ï¼Œä¸`imshow()`çš„è¾“å…¥æ ¼å¼å®Œå…¨å…¼å®¹

```python
if torch.is_tensor(img):
    ax.imshow(img.numpy())
else:
    ax.imshow(img)
```

`ndarray`ä¸`Tensor`åŒºåˆ«ï¼š

- **ndarray**

    - æ ¸å¿ƒè®¾è®¡ï¼šâ€‹**â€‹æ•°æ®å­˜å‚¨ä¸è§£é‡Šæ–¹å¼åˆ†ç¦»â€‹**â€‹ï¼Œåº•å±‚åˆ†ä¸¤éƒ¨åˆ†ï¼š

        - **æ•°æ®ç¼“å†²åŒºï¼ˆData Bufferï¼‰**ï¼šè¿ç»­å†…å­˜å—ï¼Œå­˜å‚¨åŒç±»å‹å…ƒç´ ï¼ˆå¦‚`int32`ã€`float64`ï¼‰ï¼Œç¡®ä¿å†…å­˜ç´§å‡‘é«˜æ•ˆ

        - **å…ƒæ•°æ®ï¼ˆMetadataï¼‰**ï¼šåŒ…å«`dtype`ï¼ˆæ•°æ®ç±»å‹ï¼‰ã€`shape`ï¼ˆç»´åº¦å½¢çŠ¶ï¼‰ã€`strides`ï¼ˆè·¨æ­¥å­—èŠ‚æ•°ï¼‰ç­‰ï¼Œç”¨äºè§£é‡Šæ•°æ®å¸ƒå±€

    - **ä»…é™CPUè®¡ç®—**ï¼Œå†…å­˜åˆ†é…ç”±Pythonå†…å­˜ç®¡ç†å™¨æ§åˆ¶ï¼Œæ— æ³•ç›´æ¥è®¿é—®GPUã€‚æ•°æ®è½¬æ¢ï¼ˆå¦‚`np.array()`ï¼‰éœ€æ˜¾å¼å¤åˆ¶å†…å­˜

    - **æ— è‡ªåŠ¨å¾®åˆ†èƒ½åŠ›**ï¼Œä»…ç”¨äºæ•°å€¼è®¡ç®—ï¼Œæ— æ³•è®°å½•è¿ç®—å†å²
    - **èšç„¦æ•°å€¼æ“ä½œ**ï¼šAPIè®¾è®¡å›´ç»•çŸ©é˜µè¿ç®—ï¼ˆå¦‚`reshape`ã€`transpose`ï¼‰ï¼Œé€šè¿‡`strides`å®ç°è§†å›¾ï¼ˆviewï¼‰è€Œéå¤åˆ¶æ•°æ®ï¼ˆå¦‚åˆ‡ç‰‡è¿”å›åŸæ•°æ®å¼•ç”¨ï¼‰
    - ä¾èµ–è¿ç»­å†…å­˜ä¸çŸ¢é‡åŒ–ï¼š
        - å†…å­˜è¿ç»­æ€§ï¼ˆC-order/F-orderï¼‰å½±å“`np.dot()`ç­‰å‡½æ•°çš„ç¼“å­˜æ•ˆç‡
        - é€šè¿‡`np.vectorize()`å®ç°æ— å¾ªç¯æ‰¹å¤„ç†ï¼Œä½†åº•å±‚ä»ä¾èµ–CPUæŒ‡ä»¤

- **Tensor**

    - åœ¨`ndarray`åŸºç¡€ä¸Šæ‰©å±•ï¼Œæ ¸å¿ƒç»“æ„ï¼š
        - **æ•°æ®å­˜å‚¨ï¼ˆStorageï¼‰**ï¼šç±»ä¼¼`ndarray`çš„è¿ç»­å†…å­˜å—ï¼Œä½†æ”¯æŒè·¨è®¾å¤‡ï¼ˆCPU/GPUï¼‰å­˜å‚¨
        - **æ¢¯åº¦è®¡ç®—ä¸Šä¸‹æ–‡**ï¼šåŒ…å«`grad_fn`ï¼ˆåå‘ä¼ æ’­å‡½æ•°ï¼‰ã€`requires_grad`ï¼ˆæ¢¯åº¦æ ‡è®°ï¼‰ç­‰ï¼Œæ”¯æŒè‡ªåŠ¨å¾®åˆ†
    - æ”¯æŒå¼‚æ„è®¡ç®—ï¼Œé€šè¿‡`.cuda()`å°†æ•°æ®ç§»è‡³GPUï¼Œåº•å±‚è°ƒç”¨CUDA APIåˆ†é…æ˜¾å­˜ï¼Œå…³é”®ç‰¹æ€§ï¼š
        - **å†…å­˜å…±äº«**ï¼š`torch.from_numpy(np_array)`ä¸åŸå§‹`ndarray`å…±äº«å†…å­˜ï¼Œä¿®æ”¹ä»»ä¸€å¯¹è±¡ä¼šåŒæ­¥å˜æ›´ï¼ˆé›¶æ‹·è´ï¼‰
        - **è®¾å¤‡æ„ŸçŸ¥**ï¼š`device`å±æ€§æ ‡è¯†æ•°æ®ä½ç½®ï¼ˆCPU/GPUï¼‰ï¼Œè¿ç®—è‡ªåŠ¨é€‰æ‹©åŒ¹é…è®¾å¤‡
    - æ·±åº¦é›†æˆè‡ªåŠ¨å¾®åˆ†ï¼š
        - **è®¡ç®—å›¾æ„å»º**ï¼šæ¯æ¬¡è¿ç®—ç”Ÿæˆ`Function`èŠ‚ç‚¹ï¼Œè®°å½•è¾“å…¥/è¾“å‡ºä¾èµ–ï¼ˆå¦‚`AddBackward`ï¼‰
        - **æ¢¯åº¦ä¼ æ’­**ï¼šè°ƒç”¨`.backward()`æ—¶ï¼Œæ²¿`grad_fn`é“¾åå‘è®¡ç®—æ¢¯åº¦ï¼Œå¹¶å­˜å‚¨äº`.grad`å±æ€§ä¸­
    - æ·±åº¦ä¼˜åŒ–ä¸æ‰©å±•ï¼š
        - **GPUåŠ é€Ÿè¿ç®—**ï¼šå¦‚`torch.matmul()`è°ƒç”¨CuBLASåº“å®ç°é«˜æ•ˆçŸ©é˜µä¹˜æ³•
        - **åˆ†å¸ƒå¼æ”¯æŒ**ï¼š`DistributedTensor`æ”¯æŒè·¨è®¾å¤‡åˆ†ç‰‡å­˜å‚¨ï¼ˆå¦‚æ¨¡å‹å¹¶è¡Œï¼‰
        - **æ“ä½œç¬¦é‡è½½**ï¼š`+`ã€`*`ç­‰è¿ç®—ç¬¦é‡è½½ä¸º`torch.add()`ã€`torch.mul()`ï¼Œç®€åŒ–ä»£ç 
    - å¤šå±‚æ¬¡åŠ é€Ÿï¼š
        - **å†…æ ¸èåˆï¼ˆKernel Fusionï¼‰**ï¼šå°†å¤šä¸ªæ“ä½œï¼ˆå¦‚`conv2d + relu`ï¼‰åˆå¹¶ä¸ºå•ä¸€GPUå†…æ ¸ï¼Œå‡å°‘æ˜¾å­˜è¯»å†™
        - **å¼‚æ­¥æ‰§è¡Œ**ï¼šCUDAæµï¼ˆStreamï¼‰å¹¶è¡Œæ‰§è¡Œè®¡ç®—ä¸æ•°æ®è¿ç§»ï¼Œæå‡ååé‡

|              | **ndarray**                  | **Tensor**                          |
| ------------ | ---------------------------- | ----------------------------------- |
| **å†…å­˜ç»“æ„** | æ•°æ®+å…ƒæ•°æ®åˆ†ç¦»ï¼Œè¿ç»­CPUå†…å­˜ | æ‰©å±•å­˜å‚¨ç»“æ„ï¼Œæ”¯æŒè·¨è®¾å¤‡+æ¢¯åº¦ä¸Šä¸‹æ–‡ |
| **è®¡ç®—è®¾å¤‡** | ä»…CPU                        | CPU/GPUæ— ç¼åˆ‡æ¢ï¼Œæ”¯æŒå†…å­˜å…±äº«       |
| **è‡ªåŠ¨å¾®åˆ†** | ä¸æ”¯æŒ                       | å†…ç½®è®¡ç®—å›¾ä¸æ¢¯åº¦ä¼ æ’­æœºåˆ¶            |
| **APIè®¾è®¡**  | æ•°å€¼è®¡ç®—åŸºç¡€æ“ä½œ             | æ·±åº¦ä¼˜åŒ–è¿ç®—+åˆ†å¸ƒå¼æ‰©å±•             |
| **æ€§èƒ½ä¼˜åŒ–** | å†…å­˜å¸ƒå±€ä¼˜åŒ–+CPUçŸ¢é‡åŒ–       | å†…æ ¸èåˆ+å¼‚æ­¥æ‰§è¡Œ+GPUåŠ é€Ÿ           |



## å½¢çŠ¶ä¸å†…å­˜å¸ƒå±€

**è¿ç»­å¼ é‡**ï¼šå¼ é‡åœ¨å†…å­˜ä¸­ä¸º**è¿ç»­å†…å­˜**åŒºåŸŸ**è¿ç»­æ’å¸ƒ**ï¼Œéè¿ç»­å¼ é‡åªæ˜¯ç´¢å¼•æ–¹å¼å˜äº†

**éè¿ç»­å¼ é‡**ï¼šå¯¹å¼ é‡åšäº†æŸäº›æ“ä½œï¼š**è½¬ç½®ï¼ˆ**â€‹ **â€‹`.t()`â€‹** â€‹ **ï¼‰** ã€**åˆ‡ç‰‡**ã€**permute / transpose**ï¼Œåªæ”¹å˜äº†å¼ é‡çš„â€œè§†å›¾â€ï¼ˆå³è®¿é—®æ–¹å¼ï¼‰ï¼Œè€Œæ²¡æœ‰çœŸæ­£ç§»åŠ¨å†…å­˜ä¸­çš„æ•°æ®

- **â€‹`tensor.is_contiguous()`â€‹** â€‹ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºè¿ç»­å¼ é‡
- **â€‹`tensor.contiguous()`â€‹** â€‹ï¼šæŠŠéè¿ç»­å¼ é‡è½¬ä¸ºè¿ç»­å¼ é‡

### `.view()`â€‹å’Œ`.reshape()`â€‹åŒºåˆ«

|ç‰¹æ€§|â€‹`view()`â€‹|â€‹`reshape()`â€‹|
| ------------------| -----------------------------------| --------------------------------------|
|æ˜¯å¦éœ€è¦è¿ç»­å†…å­˜|âœ… å¿…é¡»æ˜¯è¿ç»­çš„å¼ é‡ï¼ˆcontiguousï¼‰|âœ… ä¼šè‡ªåŠ¨å¤„ç†éè¿ç»­å¼ é‡ï¼ˆè‡ªåŠ¨ copyï¼‰|
|æ˜¯å¦åˆ›å»ºæ–°å¼ é‡|âŒ è¿”å›çš„æ˜¯åŸå¼ é‡çš„è§†å›¾ï¼ˆviewï¼‰|âœ… å¯èƒ½è¿”å›æ–°å¼ é‡ï¼ˆå¤åˆ¶æ•°æ®ï¼‰|
|é”™è¯¯å¤„ç†|âš  éè¿ç»­å¼ é‡ä¼šæŠ¥é”™|âœ… è‡ªåŠ¨å…¼å®¹|
|æ•ˆç‡|âœ… æ›´å¿«|â­• ç¨æ…¢ï¼ˆå› ä¸ºå¯èƒ½æ¶‰åŠå¤åˆ¶ï¼‰|

å¼ é‡**åº•å±‚å†…å­˜å¸ƒå±€æ–¹å¼ï¼ˆtensor layoutï¼‰ï¼šå³å¼ é‡å†…éƒ¨çš„æ•°æ®åœ¨å†…å­˜ä¸­æ€ä¹ˆå­˜æ”¾**

|Layout ç±»å‹|æè¿°|ç”¨é€”/ä¾‹å­|
| -------------| ----------------------------------------| ------------------------------------|
|â€‹`torch.strided`â€‹|é»˜è®¤å¸ƒå±€ï¼Œè¡Œä¼˜å…ˆï¼Œæ”¯æŒåˆ‡ç‰‡ã€è½¬ç½®ã€å¹¿æ’­|å¸¸è§„å¼ é‡è®¡ç®—ï¼Œæ¯”å¦‚å·ç§¯ã€çº¿æ€§å±‚ç­‰|
|â€‹`torch.sparse_coo`â€‹|ç¨€ç–å¼ é‡ï¼Œå‹ç¼©å­˜å‚¨ç¨€ç–æ•°æ®|å¤§é‡ 0 çš„ç¨€ç–çŸ©é˜µï¼ˆåŠ é€ŸèŠ‚çœå†…å­˜ï¼‰|
|â€‹`torch.sparse_csr`â€‹|å‹ç¼©è¡Œå­˜å‚¨çš„ç¨€ç–æ ¼å¼|æ›´é€‚åˆç¨€ç–çŸ©é˜µä¹˜æ³•ï¼ˆå¦‚å›¾ç¥ç»ç½‘ç»œï¼‰|
|â€‹`torch._mkldnn`â€‹|é’ˆå¯¹ MKL-DNN ä¼˜åŒ–çš„ç‰¹æ®Šæ ¼å¼|ç”¨äº Intel CPU çš„åŠ é€Ÿ|

```python
# torch.stridedï¼Œå†…å­˜ä¸ºè¿ç»­çš„ä¸€ç»´æ•°ç»„[1, 2, 3, 4]ï¼Œé€šè¿‡ strides(æ­¥é•¿)å†³å®šæ€ä¹ˆâ€œè·³â€åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ 
a = torch.tensor([[1, 2], [3, 4]])
# a.stride()å¯èƒ½è¿”å› (2, 1)ï¼Œæ„æ€æ˜¯ï¼šè¡Œä¹‹é—´éš” 2 ä¸ªå…ƒç´ ï¼Œåˆ—ä¹‹é—´éš” 1 ä¸ªå…ƒç´ 
```

`reshape(-1)`æˆ–`reshape(1, -1)`â€‹ï¼šå°†å¼ é‡å±•å¹³æˆä¸€ç»´å‘é‡

`torch.reshape(tensor, shape)`â€‹å’Œ`tensor.reshape(shape)`â€‹ï¼šå®Œå…¨ç­‰ä»·

(n, )å½¢çŠ¶

ä¸€ç»´å¼ é‡ï¼Œæœ‰nä¸ªå…ƒç´ ï¼Œæ— ç¬¬äºŒä¸ªç»´åº¦

## Randomä¸æ¦‚ç‡åˆ†å¸ƒ

ä¼¯åŠªåˆ©åˆ†å¸ƒé‡‡æ ·å‡½æ•°ï¼š

```python
a = torch.randd(3, 3)
torch.bernoulli(a)
```

å¯¹å¼ é‡ `a`â€‹ ä¸­çš„æ¯ä¸ªå…ƒç´  `p`â€‹ï¼Œä»¥æ¦‚ç‡ `p`â€‹ è¾“å‡º `1`â€‹ï¼Œä»¥æ¦‚ç‡ `1-p`â€‹ è¾“å‡º `0`â€‹ï¼Œç›¸å½“äºæ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€æ¬¡â€œå¸¦æƒæ¦‚ç‡çš„ç¡¬å¸æŠ›æ·â€

éšæœºç§å­ï¼šâ€‹`torch.manual_seed(seed)`â€‹è®¾ç½®å…¨å±€éšæœºæ•°ç”Ÿæˆå™¨ï¼Œå½±å“æ‰€æœ‰åç»­çš„éšæœºæ“ä½œï¼ˆé™¤éä¸­é€”ä¿®æ”¹äº†ç§å­ï¼‰

è‹¥ä½¿ç”¨äº†numpyæˆ–randomï¼Œä¹Ÿè¦åŒæ­¥è®¾ç½®

```python
import random
import numpy as np

random.seed(42)
np.random.seed(42)
torch.manual_seed(42)
# è¿™æ ·æ•´ä¸ªé¡¹ç›®çš„éšæœºè¡Œä¸ºéƒ½èƒ½å¾—åˆ°å¤ç°
```

`torch.distributions`â€‹

æä¾›å„ç§æ¦‚ç‡åˆ†å¸ƒçš„å®ç°

Multinomial åˆ†å¸ƒ: å¤šé¡¹åˆ†å¸ƒæ˜¯ç¦»æ•£åˆ†å¸ƒçš„ä¸€ç§ï¼Œç”¨äºæè¿°åœ¨æ¯ä¸ªå®éªŒä¸­æœ‰ ( n ) æ¬¡ç‹¬ç«‹è¯•éªŒï¼Œæ¯æ¬¡è¯•éªŒæœ‰ ( k ) ä¸ªå¯èƒ½çš„ç»“æœçš„æƒ…å†µã€‚è¿™ä¸ªåˆ†å¸ƒçš„è¾“å‡ºæ˜¯ä¸€ä¸ªå‘é‡ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ è¡¨ç¤ºæ¯ä¸ªå¯èƒ½ç»“æœå‡ºç°çš„æ¬¡æ•°

```python
from torch.distributions import Multinomial

probs = torch.tensor([0.2, 0.5, 0.3])	# å®šä¹‰æ¦‚ç‡

n = 10  # æ¯æ¬¡è¯•éªŒçš„æ€»æ¬¡æ•°

multinomial_dist = Multinomial(total_count=n, probs=probs)	# åˆ›å»ºå¤šé¡¹åˆ†å¸ƒå¯¹è±¡
```

ä¸»è¦å‚æ•°:

- total\_count: ä¸€ä¸ªæ•´æ•°ï¼Œè¡¨ç¤ºæ¯æ¬¡è¯•éªŒçš„æ€»æ¬¡æ•° n
- probs: ä¸€ä¸ªå½¢çŠ¶ä¸º ( (k,) ) çš„å¼ é‡ï¼Œè¡¨ç¤ºæ¯ç§ç»“æœçš„æ¦‚ç‡ï¼Œè¿™äº›æ¦‚ç‡åº”è¯¥æ˜¯éè´Ÿçš„ï¼Œå¹¶ä¸”å®ƒä»¬çš„æ€»å’Œåº”è¯¥ç­‰äº 1
- logits: å¯é€‰ï¼Œä½¿ç”¨ logits è€Œä¸æ˜¯æ¦‚ç‡æ¥è¡¨ç¤ºç»“æœçš„åå¥½

æ–¹æ³•ï¼š

- `.sample()`: ä»å¤šé¡¹åˆ†å¸ƒä¸­ç”Ÿæˆæ ·æœ¬
- `.log_prob(sample)`: è®¡ç®—ç»™å®šæ ·æœ¬çš„å¯¹æ•°æ¦‚ç‡

## æ•°å­¦è¿ç®—ä¸æ•°å€¼æ“ä½œ

**åŸåœ°æ“ä½œï¼ˆin-placeï¼‰** ï¼š

- torchä¸­æ–¹æ³•æœ«å°¾çš„`_`â€‹è¡¨åŸåœ°æ“ä½œ
- +\=/-=ï¼š**ä¼˜å…ˆ**è°ƒç”¨`INPLACE_ADD`â€‹ï¼ˆåŸåœ°åŠ æ³•ï¼‰æ“ä½œç¬¦ï¼Œå¯¹**å¯å˜å¯¹è±¡**ï¼ˆå¦‚åˆ—è¡¨ã€å­—å…¸ã€é›†åˆï¼‰ï¼šç›´æ¥ä¿®æ”¹åŸå¯¹è±¡ï¼Œæ— éœ€åˆ›å»ºæ–°å¯¹è±¡ï¼Œ**ä¸å¯å˜å¯¹è±¡**ï¼ˆå¦‚æ•´æ•°ã€å­—ç¬¦ä¸²ã€å…ƒç»„ï¼‰`INPLACE_ADD`â€‹å®é™…ä¼šåˆ›å»ºæ–°å¯¹è±¡å¹¶é‡æ–°èµ‹å€¼ç»™å˜é‡ï¼Œæ€»ä¹‹`+=`â€‹å’Œ`-=`â€‹ä¸ç¡®å®šæ˜¯å¦åŸåœ°ä¿®æ”¹ï¼Œä½¿ç”¨`[:]`â€‹ç¡®ä¿åŸåœ°ä¿®æ”¹
- [:]ï¼š

```python
weight.data[:] -= something 	# ä½¿ç”¨[:]å®ŒæˆåŸåœ°æ“ä½œï¼Œå®è·µä¸­ä¸æ¨èè¿™ä¹ˆå†™

# æ¨èå†™æ³•
with torch.no_grad():
    weight -= something
```

â€

`.norm()`â€‹ï¼šè®¡ç®—å¼ é‡çš„èŒƒæ•°ï¼Œæ”¯æŒå¤šç§èŒƒæ•°ï¼Œé»˜è®¤ä¸ºğ¿2èŒƒæ•°

```python
tensor.norm(p='fro', dim=None, keepdim=False, out=None)
```

**â€‹`p`â€‹**: èŒƒæ•°çš„ç±»å‹ï¼Œå¸¸è§å–å€¼ï¼š

- `p=2`â€‹ï¼šL2èŒƒæ•°ï¼Œé»˜è®¤å€¼ï¼Œè®¡ç®—æ¬§å‡ é‡Œå¾—èŒƒæ•°
- `p=1`â€‹ï¼šL1èŒƒæ•°ï¼Œè®¡ç®—å…ƒç´ çš„ç»å¯¹å€¼ä¹‹å’Œ
- `p=float('inf')`â€‹ï¼šLâˆèŒƒæ•°ï¼Œè®¡ç®—æœ€å¤§ç»å¯¹å€¼å…ƒç´ 
- `p='fro'`â€‹ï¼šFrobenius èŒƒæ•°ï¼ˆé€‚ç”¨äºçŸ©é˜µï¼‰

**â€‹`dim`â€‹**: è®¡ç®—æ²¿ç€æŸä¸€ç»´åº¦çš„èŒƒæ•°ï¼Œç»“æœä¸æ˜¯æ ‡é‡

**â€‹`keepdim`â€‹**: æ˜¯å¦ä¿æŒè®¡ç®—åç»“æœçš„ç»´åº¦

**â€‹`out`â€‹**: å­˜æ”¾ç»“æœçš„å¼ é‡

`torch.clamp()`â€‹ï¼šè£å‰ªï¼Œé™åˆ¶å¼ é‡çš„æ•°å€¼åœ¨æŒ‡å®šèŒƒå›´å†…

```python
torch.clamp(input, min=None, max=None, *, out=None)
# input: è¦è£å‰ªçš„å¼ é‡
# min: æœ€å°å€¼ï¼Œä½äºminåˆ™è®¾ä¸ºmin
# max: æœ€å¤§å€¼ï¼Œé«˜äºmaxåˆ™è®¾ä¸ºmax
# out: å¯é€‰ï¼ŒæŒ‡å®šè¾“å‡ºå¼ é‡
```

`torch.where(condition, A, B)`â€‹ï¼šè‹¥conditionä¸ºTrueï¼Œåˆ™å–Aï¼Œå¦åˆ™å–B

|å‡½æ•°|ç±»å‹|åŠŸèƒ½ç®€ä»‹|è¡Œä¸ºåŒºåˆ«|
| ------| ---------| -----------------------------------------| -------------------------------------------|
|â€‹`torch.where(cond, A, B)`â€‹|PyTorch|æ¡ä»¶é€‰æ‹©ï¼šcondä¸ºTrueé€‰Aï¼Œå¦åˆ™é€‰B|å’ŒNumPyä¸€è‡´ï¼Œ**å¿…é¡»**æä¾› Aã€B|
|â€‹`np.where(cond, A, B)`â€‹|NumPy|æ¡ä»¶é€‰æ‹©ï¼šcondä¸ºTrueé€‰Aï¼Œå¦åˆ™é€‰B|Aã€B å¯é€‰ï¼šä¸ä¼ Aã€Bæ—¶è¿”å›ç´¢å¼•|
|â€‹`df.where(cond)`â€‹|Pandas|å¯¹DataFrameä¸­condä¸ºFalseçš„åœ°æ–¹æ›¿æ¢ä¸ºNaN|å’Œä¸Šé¢ä¸¤ä¸ªä¸åŒï¼Œæ˜¯â€œä¿ç•™Trueï¼Œæ›¿æ¢Falseâ€|

### `np.where(cond, A, B)`â€‹ å’Œ `np.where(cond)`â€‹

ä¸¤ç§ç”¨æ³•ï¼š

- ä¸‰å‚æ•°ï¼šè·Ÿ PyTorch ä¸€æ ·
- ä¸€å‚æ•°ï¼šè¿”å›æ»¡è¶³æ¡ä»¶çš„ **ç´¢å¼•**

```python
import numpy as np
x = np.array([10, 20, 30])
cond = x > 15
np.where(cond)        # (array([1, 2]),)
np.where(cond, 1, 0)  # array([0, 1, 1])
```

### `pandas.DataFrame.where(cond)`â€‹

- åŠŸèƒ½æ˜¯ä¿ç•™ `cond=True`â€‹ çš„ä½ç½®ï¼Œå…¶ä»–ä½ç½®è®¾ä¸º `NaN`â€‹ï¼ˆæ˜¯â€œ**ä¿ç•™ True**â€ï¼Œå’Œ `torch/np.where`â€‹ æ˜¯â€œ**é€‰ True**â€çš„æ€ç»´æ–¹å¼ä¸åŒï¼‰

```python
import pandas as pd
df = pd.DataFrame({'A': [1, 2, 3]})
cond = df['A'] > 1
df.where(cond)
#     A
# 0  NaN
# 1  2.0
# 2  3.0
```

â€

ä¹˜æ³•ï¼š

- `torch.matmul()`: é€šç”¨çŸ©é˜µä¹˜æ³•ï¼Œæ¨èï¼Œæ”¯æŒå¹¿æ’­ï¼Œçµæ´»
- `torch.mm()`: å±€é™äºäºŒç»´çŸ©é˜µä¹˜æ³•ï¼Œä¸æ”¯æŒå¹¿æ’­å’Œæ‰¹é‡æ“ä½œ
- `torch.mv()`: å±€é™äºçŸ©é˜µä¸å‘é‡ä¹˜æ³•ï¼Œä¸æ”¯æŒå¹¿æ’­å’Œæ‰¹é‡æ“ä½œ
- `torch.mul()`: å…ƒç´ çº§ä¹˜æ³•ï¼Œå¯¹åº”ä½ç½®çš„å…ƒç´ ç›¸ä¹˜

â€

# äºŒ. ç¥ç»ç½‘ç»œæ„å»ºï¼ˆtorch.nnï¼‰

æä¾›ç¥ç»ç½‘ç»œå±‚ã€æŸå¤±å‡½æ•°å’Œæ¨¡å‹åŸºç±»

## å‚æ•°ç®¡ç†

- `.parameters()`â€‹ï¼šè¿”å›æ‰€æœ‰**å¯è®­ç»ƒå‚æ•°**ï¼ˆå½“å‰æ¨¡å—å’Œå­æ¨¡å—ä¸­æ‰€æœ‰å‚æ•°çš„æ‰å¹³**è¿­ä»£å™¨**ï¼‰ï¼Œ**ä¸æŒ‰æ¨¡å—å±‚çº§åŒºåˆ†**ï¼Œé€šå¸¸æ˜¯ **â€‹`torch.nn.Parameter`â€‹**â€‹ ç±»å‹çš„å¼ é‡ï¼ŒåŒ…æ‹¬æƒé‡ã€åç½®ç­‰ï¼Œç”¨äº**ä¼˜åŒ–å™¨ä¼ å‚**ï¼Œ åªåŒ…å«æ¨¡å‹ä¸­éœ€è¦æ¢¯åº¦çš„å‚æ•°ï¼Œä¸èƒ½ç›´æ¥ä¿å­˜/åŠ è½½æ¨¡å‹ç»“æ„/çŠ¶æ€ï¼Œå¯å¯¹ç‰¹å®šå­æ¨¡å—å•ç‹¬è°ƒç”¨ `.parameters()`â€‹ï¼Œåˆ†æ¨¡å—è®­ç»ƒéœ€ç”¨ `named_parameters()`â€‹ï¼Œé€šè¿‡å­—ç¬¦ä¸² `name`â€‹ åˆ¤æ–­å‚æ•°å±äºå“ªä¸ªå­æ¨¡å—
- `.named_parameters()`â€‹ï¼šè¿”å›æ¨¡å‹ä¸­**æ‰€æœ‰å¯è®­ç»ƒå‚æ•°**çš„åå­—å’Œå‚æ•°æœ¬èº«çš„è¿­ä»£å™¨
- `.named_children()`â€‹ï¼šè¿”å›æ¨¡å—çš„**ç›´æ¥**å­æ¨¡å—ï¼ˆå¸¦åå­—ï¼‰
- `.named_modules()`â€‹ï¼šè¿”å›æ¨¡å‹ä¸­**æ‰€æœ‰**å­æ¨¡å—åŠå…¶åç§°
- `.children()`ï¼šè¿”å›å½“å‰æ¨¡å—çš„ç¬¬ä¸€ä¸ªå­æ¨¡å—
- `.modules()`ï¼šé€’å½’åœ°è¿”å›æ‰€æœ‰å­æ¨¡å—çš„**ç”Ÿæˆå™¨**
- `.state_dict()`â€‹ï¼šè·å–æ‰€æœ‰æ¨¡å‹çš„â€œçŠ¶æ€ä¿¡æ¯â€ï¼Œè¿”å›ä¸€ä¸ª **å­—å…¸ï¼ˆ**â€‹**â€‹`OrderedDict`â€‹**â€‹ **ï¼‰** ï¼Œé”®æ˜¯å‚æ•°æˆ–ç¼“å­˜å˜é‡çš„åå­—ï¼Œå€¼æ˜¯å¼ é‡ï¼ŒåŒ…å«æ‰€æœ‰æƒé‡å’Œåç½®ã€æœ‰äº›éè®­ç»ƒå‚æ•°ï¼ˆå¦‚ BatchNorm çš„ running\_mean å’Œ running\_varï¼‰ï¼Œå¸¸ç”¨äºï¼š
- **ä¿å­˜æ¨¡å‹å‚æ•°ï¼š**  `torch.save(model.state_dict(), "model.pth")`â€‹
- **åŠ è½½æ¨¡å‹å‚æ•°ï¼š**  `model.load_state_dict(torch.load("model.pth"))`â€‹

|ç‰¹æ€§|â€‹`.parameters()`â€‹|â€‹`.state_dict()`â€‹|
| ------------------| ------------------------| -----------------------------------------|
|è¿”å›ç±»å‹|è¿­ä»£å™¨ï¼Œå…ƒç´ æ˜¯`Parameter`â€‹|æœ‰åºå­—å…¸ï¼Œkey æ˜¯åå­—ï¼Œvalue æ˜¯å¼ é‡|
|åŒ…å«å†…å®¹|å¯è®­ç»ƒå‚æ•°ï¼ˆéœ€è¦æ¢¯åº¦ï¼‰|æ‰€æœ‰å‚æ•° + ç¼“å­˜ï¼ˆå¦‚ BN å±‚çš„å‡å€¼ã€æ–¹å·®ï¼‰|
|ç”¨é€”|é€šå¸¸ç”¨äºä¼ ç»™ä¼˜åŒ–å™¨|é€šå¸¸ç”¨äºä¿å­˜ã€åŠ è½½æ¨¡å‹çŠ¶æ€|
|æ˜¯å¦åŒ…å«åå­—|âŒï¼ˆé™¤éç”¨`named_parameters()`â€‹ï¼‰|âœ…ï¼ˆkey å°±æ˜¯å‚æ•°åï¼‰|
|æ˜¯å¦åŒ…å«ç¼“å­˜å‚æ•°|âŒ|âœ…ï¼ˆå¦‚`running_mean`â€‹,`running_var`â€‹ï¼‰|

``$\tilde h_t$å½“å‰æ—¶é—´æ­¥å€™é€‰è®°å¿†ï¼Œâ„ğ‘¡å½“å‰æ—¶é—´æ­¥æœ€ç»ˆéšè—çŠ¶æ€

è·å–CPUæ ¸å¿ƒæ•°é‡ï¼š`os.cpu_count()`â€‹

è·å–GPUæ ¸å¿ƒæ•°é‡ï¼š`torch.cuda.device_count()`â€‹

â€

`nn.Conv2d`æœ‰å±æ€§`kernel_size`



## æŸå¤±å‡½æ•°

- `nn.CrossEntropyLoss()`â€‹ï¼šè¾“å…¥å¿…é¡»æ˜¯æœªå½’ä¸€åŒ–çš„åŸå§‹logitsï¼ˆæ¨¡å‹æœ€åä¸€å±‚çš„ç›´æ¥è¾“å‡ºï¼‰ï¼Œå†…éƒ¨é›†æˆSoftmaxå’Œå¯¹æ•°è®¡ç®—ï¼ˆç¨³å®šæ€§æŠ€å·§ï¼‰

  å‚æ•°`reduction`â€‹ï¼šå†³å®šå¦‚ä½•å¯¹**æ‰¹é‡ï¼ˆbatchï¼‰ä¸­æ¯ä¸ªæ ·æœ¬çš„æŸå¤±å€¼**è¿›è¡Œæ±‡æ€»ï¼Œå…±æœ‰ä¸‰ä¸ªé€‰é¡¹ï¼š

  - `'mean'`â€‹ï¼šè¿”å›æ‰€æœ‰æ ·æœ¬æŸå¤±çš„å¹³å‡å€¼
  - `'sum'`â€‹ï¼šè¿”å›æ‰€æœ‰æ ·æœ¬æŸå¤±çš„æ€»å’Œ
  - `'none'`â€‹ï¼šä¸è¿›è¡Œä»»ä½•èšåˆï¼Œç›´æ¥è¿”å›æ¯ä¸ªæ ·æœ¬çš„ç‹¬ç«‹æŸå¤±å€¼ï¼ˆå½¢çŠ¶ä¸º `[batch_size]`â€‹ï¼‰
- `nn.BCEWithLogitsLoss()`â€‹ï¼šç”¨äºäºŒåˆ†ç±»ä»»åŠ¡çš„æŸå¤±å‡½æ•°, Binary Cross Entropy with Logits Lossï¼Œæ„ä¸ºå¸¦æœ‰ logit è¾“å…¥çš„äºŒå…ƒäº¤å‰ç†µæŸå¤±å‡½æ•°

  - Logitsï¼šæ²¡æœ‰ç»è¿‡ Sigmoid çš„åŸå§‹è¾“å‡ºåˆ†æ•°ï¼ˆé€šå¸¸æ˜¯ä»»æ„å®æ•°ï¼‰ï¼Œä¸æ˜¯æ¦‚ç‡
- `nn.MSELoss()`â€‹ï¼š

â€

## æ¨¡å‹çš„è¡Œä¸ºæ¨¡å¼

### **â€‹`net.train()`â€‹** â€‹ **ï¼šè®­ç»ƒæ¨¡å¼**

- **â€‹`Dropout`â€‹**â€‹ï¼šè®­ç»ƒæ—¶Dropout ä¼šéšæœº **ä¸¢å¼ƒ** ä¸€éƒ¨åˆ†ç¥ç»å…ƒï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆ
- **â€‹`BatchNorm`â€‹**â€‹ï¼šBatchNorm å±‚ä½¿ç”¨ **å½“å‰æ‰¹æ¬¡çš„ç»Ÿè®¡ä¿¡æ¯**ï¼ˆå³å½“å‰æ‰¹æ¬¡çš„å‡å€¼å’Œæ–¹å·®ï¼‰è¿›è¡Œæ ‡å‡†åŒ–

### **â€‹`net.eval()`â€‹** â€‹ **ï¼šè¯„ä¼°æ¨¡å¼/æ¨ç†æ¨¡å¼**

- **â€‹`Dropout`â€‹**â€‹ï¼šåœ¨è¯„ä¼°æ¨¡å¼ä¸‹ï¼ŒDropout å±‚ä¼š **ä¸ä¸¢å¼ƒä»»ä½•ç¥ç»å…ƒ**ï¼Œå³ä½¿ç”¨ **æ‰€æœ‰ç¥ç»å…ƒ**
- **â€‹`BatchNorm`â€‹**â€‹ï¼šåœ¨è¯„ä¼°æ¨¡å¼ä¸‹ï¼ŒBatchNorm å±‚ä¼šä½¿ç”¨ **è®­ç»ƒæœŸé—´è®¡ç®—çš„å…¨å±€å‡å€¼å’Œæ–¹å·®**ï¼Œè€Œä¸å†ä¾èµ–å½“å‰æ‰¹æ¬¡

â€

# ä¸‰. ä¼˜åŒ–å™¨ï¼ˆtorch.optimï¼‰

å‚æ•°ä¼˜åŒ–ç®—æ³•å®ç°

**å¸¸ç”¨ä¼˜åŒ–å™¨**ï¼š

- `optim.SGD`â€‹, `optim.Adam`â€‹, `optim.RMSprop`â€‹
- å­¦ä¹ ç‡è°ƒåº¦å™¨ï¼š`optim.lr_scheduler.StepLR`â€‹

â€

# å››. è‡ªåŠ¨å¾®åˆ†ï¼ˆtorch.autogradï¼‰

åŠ¨æ€è®¡ç®—å›¾ä¸æ¢¯åº¦è®¡ç®—

**å…³é”®æ–¹æ³•**ï¼š

- `requires_grad=True`â€‹ å¯ç”¨æ¢¯åº¦è¿½è¸ª
- `.backward()`â€‹ åå‘ä¼ æ’­
- `torch.no_grad()`â€‹ ç¦ç”¨æ¢¯åº¦

## VariableåºŸå¼ƒ

æ—©æœŸç”¨äºåŒ…è£…ä¸€ä¸ªå¼ é‡ï¼Œä»¥å¯ç”¨è‡ªåŠ¨æ±‚å¯¼åŠŸèƒ½ï¼Œç°å·²å’ŒTensoråŠŸèƒ½åˆå¹¶

## backward()

æ ¹æ®æŸä¸ª**æ ‡é‡**è¾“å‡ºï¼Œè‡ªåŠ¨è®¡ç®—æ ‡é‡å¯¹æ‰€æœ‰æ¶‰åŠçš„å‚æ•°çš„æ¢¯åº¦ï¼Œå¹¶å°†æ¢¯åº¦ä¼ é€’å›æ¨¡å‹çš„æ¯ä¸€å±‚ï¼Œå¸®åŠ©ä¼˜åŒ–å‚æ•°ã€‚é€šå¸¸åœ¨æŸå¤±å‡½æ•°ä¸Šè°ƒç”¨ï¼Œæ›´æ–°ç½‘ç»œçš„å‚æ•°

```python
x = torch.tensor([2.0, 3.0], requires_grad=True)
y = x**2 + 2*x
loss = y.sum()
loss.backward()
print(x.grad)
```

> æ³¨æ„ï¼šå¿…é¡»åœ¨æ ‡é‡å¼ é‡ä¸Šè°ƒç”¨

ä¸¤ä¸ªå‚æ•°ï¼š`y.backward(torch.ones_like(x), retain_graph=True)`

- gradientï¼šæŒ‡å®šåå‘ä¼ æ’­çš„â€œæƒé‡å› å­â€ï¼Œéæ ‡é‡è¿›è¡Œæ¢¯åº¦è®¡ç®—æ—¶å°†è¾“å‡ºåŠ æƒä¸ºæ ‡é‡
- retain_graphï¼šä¿ç•™è®¡ç®—å›¾ï¼Œå…è®¸å¤šæ¬¡è°ƒç”¨`backward()`è€Œä¸æŠ¥é”™ï¼Œæ¢¯åº¦ä¼šç´¯åŠ åˆ°.gradä¸­
    - PyTorché»˜è®¤åœ¨å•æ¬¡åå‘ä¼ æ’­åè‡ªåŠ¨é‡Šæ”¾è®¡ç®—å›¾ä»¥èŠ‚çœå†…å­˜ï¼ŒäºŒæ¬¡ä¼ æ’­ä¼šæŠ¥é”™

### **â€‹`net.freeze()`â€‹** â€‹ **ï¼šæ‰‹åŠ¨å†»ç»“å±‚**

å†»ç»“æ¨¡å‹çš„éƒ¨åˆ†å±‚ï¼ˆå³ä¸è®¡ç®—è¯¥å±‚çš„æ¢¯åº¦ï¼‰ï¼Œé¿å…å¯¹æŸäº›å±‚è¿›è¡Œæ›´æ–°ï¼Œé€šå¸¸ç”¨äº **å¾®è°ƒ**

## æ¢¯åº¦ç›¸å…³ä¸Šä¸‹æ–‡ç®¡ç†å™¨å’Œå‡½æ•°

### `torch.no_grad()`â€‹ï¼š

ç”¨äºåœ¨ç‰¹å®šä»£ç å—ä¸­**ä¸´æ—¶**ç¦ç”¨æ¢¯åº¦è®¡ç®—ï¼Œå¯æ˜¾è‘—å‡å°‘æ˜¾å­˜å ç”¨ï¼ˆé¿å…å­˜å‚¨ä¸­é—´æ¢¯åº¦ï¼‰å¹¶æå‡è®¡ç®—æ•ˆç‡

#### **1. å·¥ä½œæœºåˆ¶**

1. ä¿å­˜å½“å‰æ¢¯åº¦çŠ¶æ€ï¼š`torch.is_grad_enabled()`â€‹
2. å…³é—­æ¢¯åº¦è®¡ç®—ï¼š`torch.set_grad_enabled(False)`â€‹
3. æ‰§è¡Œä»£ç å—
4. æ¢å¤åŸçŠ¶æ€ï¼šé€šè¿‡ `finally`â€‹ æ¢å¤åŸçŠ¶æ€

#### **2. æ³¨æ„äº‹é¡¹**

- æ”¯æŒåµŒå¥—ï¼Œå†…å±‚ä¸Šä¸‹æ–‡ä¸ä¼šè¦†ç›–å¤–å±‚çŠ¶æ€ï¼Œä½†æ¢¯åº¦è®¡ç®—å§‹ç»ˆå¤„äºå…³é—­çŠ¶æ€
- é€šå¸¸ç»“åˆ `model.eval()`â€‹ ä½¿ç”¨
- é€€å‡ºä¸Šä¸‹æ–‡åï¼Œæ¢¯åº¦è®¡ç®—è‡ªåŠ¨æ¢å¤ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
- åœ¨ä¸Šä¸‹æ–‡ä¸­ï¼ŒåŸåœ°ä¿®æ”¹ä»ä¼šæ‰§è¡Œï¼Œä½†ä¸ä¼šè®°å½•æ¢¯åº¦

#### **3. ä¸å…¶ä»–æ–¹æ³•å¯¹æ¯”**

|**æ–¹æ³•**|**ä½œç”¨èŒƒå›´**|**é€‚ç”¨åœºæ™¯**|
| ------| ------------| ----------------------------------|
|â€‹`torch.no_grad()`â€‹|ä»£ç å—|ä¸´æ—¶ç¦ç”¨æ¢¯åº¦ï¼ˆæ¨èç”¨äºå±€éƒ¨æ“ä½œï¼‰|
|â€‹`@torch.no_grad()`â€‹|æ•´ä¸ªå‡½æ•°|è£…é¥°å™¨å½¢å¼ï¼Œé€‚ç”¨äºæ¨ç†å‡½æ•°|
|â€‹`torch.set_grad_enabled(False)`â€‹|å…¨å±€æˆ–å±€éƒ¨|éœ€æ‰‹åŠ¨æ¢å¤çŠ¶æ€ï¼Œçµæ´»æ€§è¾ƒä½|

### `torch.enable_grad()`â€‹

å¼ºåˆ¶å¯ç”¨æ¢¯åº¦è®¡ç®—ï¼ˆå³ä½¿å¤–å±‚æœ‰ `no_grad()`â€‹ï¼‰

### `torch.autograd.grad()`â€‹

ç›´æ¥è®¡ç®—è¾“å‡ºå¯¹è¾“å…¥çš„æ¢¯åº¦

å‚æ•°ï¼š

- `outputs`â€‹ï¼šå¾…æ±‚å¯¼çš„ç›®æ ‡å¼ é‡
- `inputs`â€‹ï¼šéœ€è¦è®¡ç®—æ¢¯åº¦çš„è¾“å…¥å¼ é‡
- `grad_outputs`â€‹ï¼šæƒé‡å‘é‡ï¼ˆç”¨äºè°ƒæ•´æ¢¯åº¦æ–¹å‘ï¼‰

### `torch.inference_mode()`â€‹

ä¸“ç”¨äºæ¨ç†åœºæ™¯ï¼Œæä¾›æ¯”no\_grad()æ›´é«˜æ•ˆçš„è¿è¡Œæ—¶æ€§èƒ½ï¼Œä¼˜åŒ–äº†å¼ é‡çš„å†…å­˜ç®¡ç†å’Œè®¡ç®—

Pytorch1.10ç‰ˆæœ¬ä»¥ä¸Šä¼˜å…ˆè€ƒè™‘ä½¿ç”¨`torch.inference_mode()`â€‹



# äº”. **æ•°æ®å¤„ç† (**â€‹**â€‹`torch.utils.data`â€‹**â€‹ **)ä¸ä¿å­˜**

æ•°æ®é›†åŠ è½½ä¸æ‰¹å¤„ç†

## **æ ¸å¿ƒç±»**ï¼š

- `.Dataset`: è‡ªå®šä¹‰æ•°æ®é›†åŸºç±»ï¼Œç»§æ‰¿éœ€å®ç°`__getitem__`â€‹å’Œ`__len__`â€‹æ–¹æ³•

  - è‡ªå®šä¹‰æ•°æ®é›†ç¤ºä¾‹ï¼š

    ```python
    from torch.utils.data import Dataset
    class CustomDataset(Dataset):
        def __init__(self, data, labels, transform=None):
            self.data = data
            self.labels = labels
            self.transform = transform
    
        def __getitem__(self, index):
            x = self.data[index]
            if self.transform:
                x = self.transform(x)
            return x, self.labels[index]
    
        def __len__(self):
            return len(self.data)
    ```
  - å¸¸ç”¨æ´¾ç”Ÿç±»ï¼š

    - `TensorDataset`: ç›´æ¥åŒ…è£…å¼ é‡æ•°æ®
    - `IterableDataset`: æµå¼æ•°æ®æ”¯æŒ
  - ä¸`torchvision.datasets`â€‹ï¼š

    - åŒºåˆ«ï¼š

      |**ç‰¹æ€§**|**torchvision.datasets**|**torch.utils.data.Dataset**(åŸºç¡€ç±»)|
      | --| --------------------------------------------------| ---------------------------------------------------|
      |**å®šä½**|ä¸“é—¨ç”¨äºè®¡ç®—æœºè§†è§‰ä»»åŠ¡ï¼ˆå¦‚å›¾åƒåˆ†ç±»ã€ç›®æ ‡æ£€æµ‹ï¼‰|é€šç”¨æ•°æ®åŠ è½½æŠ½è±¡ç±»ï¼Œé€‚ç”¨äºä»»ä½•é¢†åŸŸï¼ˆNLPã€éŸ³é¢‘ç­‰ï¼‰|
      |**å†…ç½®æ•°æ®é›†**|æä¾›å¸¸è§è§†è§‰æ•°æ®é›†ï¼ˆå¦‚MNISTã€CIFARã€ImageNetç­‰ï¼‰|æ— å†…ç½®æ•°æ®é›†ï¼Œéœ€ç”¨æˆ·è‡ªå®šä¹‰æˆ–ç»§æ‰¿å®ç°|
      |**æ•°æ®é¢„å¤„ç†**|é€šå¸¸é…åˆ`torchvision.transforms`â€‹è¿›è¡Œå›¾åƒå¢å¼ºå’Œå½’ä¸€åŒ–|éœ€ç”¨æˆ·æ‰‹åŠ¨å®ç°é¢„å¤„ç†é€»è¾‘|
      |**åŠŸèƒ½æ‰©å±•**|å°è£…äº†æ•°æ®ä¸‹è½½ã€è§£å‹ã€æ ‡å‡†åŒ–ç­‰æµç¨‹|ä»…æä¾›æ•°æ®åŠ è½½çš„æŠ½è±¡æ¥å£ï¼ˆéœ€å®ç°`__getitem__`â€‹å’Œ`__len__`â€‹ï¼‰|
    - åä½œäº’è¡¥ï¼š`torchvision.datasets`â€‹ç»§æ‰¿è‡ª`torch.utils.data.Dataset`â€‹ï¼Œå¯æ— ç¼ç»“åˆ

      ```python
      from torch.utils.data import DataLoader
      loader = DataLoader(dataset, batch_size=32, shuffle=True)  # é€šç”¨æ•°æ®åŠ è½½å™¨
      ```

      - `DataLoader`â€‹ çš„å‚æ•°ï¼ˆå¦‚ `batch_size`â€‹, `shuffle`â€‹, `num_workers`â€‹ï¼‰é€‚ç”¨äºä»»ä½• `Dataset`â€‹ å­ç±»

      - **äº’è¡¥æ€§**ï¼š`torchvision`â€‹ åœ¨ `Dataset`â€‹ åŸºç¡€ä¸Šæ·»åŠ äº†è§†è§‰ä¸“ç”¨åŠŸèƒ½ï¼Œä¸¤è€…é€šè¿‡ `DataLoader`â€‹ ç»Ÿä¸€è°ƒåº¦
- `.DataLoader`: æ‰¹é‡åŠ è½½ã€å¤šçº¿ç¨‹æ”¯æŒ

  ![image](../../assets//image-20250606195157-xw541g1.png)

  - å‚æ•°ï¼š

    - `dataset`â€‹ï¼šå¿…é¡»ä¼ å…¥ç»§æ‰¿è‡ª`torch.utils.data.Dataset`â€‹çš„å¯¹è±¡ï¼Œå®šä¹‰æ•°æ®æ¥æºåŠå•ä¸ªæ ·æœ¬çš„è·å–æ–¹å¼
    - `batch_size`â€‹ï¼šæ¯æ‰¹æ¬¡çš„æ ·æœ¬æ•°ï¼ˆé»˜è®¤1ï¼‰ï¼Œéœ€æ ¹æ®æ˜¾å­˜è°ƒæ•´ï¼Œè¿‡å¤§å¯èƒ½å¯¼è‡´æº¢å‡ºï¼Œè¿‡å°å½±å“æ•ˆç‡
    - `shuffle`â€‹ï¼šæ˜¯å¦åœ¨æ¯ä¸ªepochå¼€å§‹æ—¶æ‰“ä¹±æ•°æ®é¡ºåºï¼ˆé»˜è®¤`False`â€‹ï¼‰ï¼Œè®­ç»ƒé›†é€šå¸¸è®¾ä¸º`True`â€‹ä»¥å¢å¼ºæ³›åŒ–èƒ½åŠ›
    - `num_workers`â€‹ï¼šå­è¿›ç¨‹æ•°ï¼ˆé»˜è®¤0ï¼Œå³ä¸»è¿›ç¨‹åŠ è½½ï¼‰ï¼Œå¢åŠ å¯åŠ é€Ÿæ•°æ®åŠ è½½ï¼Œä½†éœ€é¿å…è¶…è¿‡CPUæ ¸å¿ƒæ•°

â€

```python
from torch.utils.data import DataLoader

train_loader = DataLoader(
    dataset=train_dataset,  # æ•°æ®é›†å¯¹è±¡
    batch_size=32,         # æ‰¹æ¬¡å¤§å°
    shuffle=True,          # è®­ç»ƒæ—¶æ‰“ä¹±æ•°æ®
    num_workers=4,         # 4ä¸ªå­è¿›ç¨‹åŠ è½½
    pin_memory=True,       # åŠ é€ŸGPUä¼ è¾“
    drop_last=True         # ä¸¢å¼ƒä¸å®Œæ•´æ‰¹æ¬¡
)
```

### æ³¨æ„äº‹é¡¹

- **GPUè®­ç»ƒ**ï¼šå¯ç”¨`pin_memory`â€‹å¯æå‡æ€§èƒ½ã€‚
- **åŠ¨æ€æ•°æ®**ï¼šä½¿ç”¨`collate_fn`â€‹å¤„ç†å˜é•¿æ•°æ®ã€‚
- **èµ„æºå¹³è¡¡**ï¼š`num_workers`â€‹è¿‡å¤šå¯èƒ½å¯¼è‡´ç«äº‰ï¼Œå»ºè®®æ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´ã€‚

æ›´å¤šç»†èŠ‚å¯å‚è€ƒPyTorchå®˜æ–¹æ–‡æ¡£ã€‚

## å¸¸ç”¨æ–¹æ³•ï¼š

- `.random_split(dataset, [train_size, test_size])`â€‹ï¼šåˆ’åˆ†æ•°æ®é›†
- â€

## æ¨¡å‹çš„ä¿å­˜å’ŒåŠ è½½ï¼š

- ä¿å­˜ï¼š`torch.save(model.state_dict(), 'model.pth')`â€‹ï¼Œåªä¿å­˜æ¨¡å‹çš„å‚æ•°ï¼ŒåŠ è½½æ—¶éœ€è¦å…ˆå®šä¹‰æ¨¡å‹çš„æ¶æ„
- åŠ è½½ï¼š`model.load_state_dict(torch.load('model.pth'))`â€‹ï¼Œ`torch.load()`â€‹åªåŠ è½½æ¨¡å‹å‚æ•°ï¼Œéœ€ç”¨`.load_state_dict()`â€‹å°†æ¨¡å‹å‚æ•°åŠ è½½åˆ°æ¨¡å‹å®ä¾‹ä¸­

â€

# å…­. è®¾å¤‡ç®¡ç†ä¸**GPU åŠ é€Ÿ (**â€‹**â€‹`torch.cuda`â€‹**â€‹ **)**

- `torch.device`â€‹

  - `device = torch.device('mps' if torch.backends.mps.is_available() else 'cpu')`â€‹
- `torch.to(device)`â€‹ï¼šæ•°æ®è¿ç§»

  - `x = x.to('cpu' æˆ– 'mps')`â€‹
- `torch.cuda`â€‹

  - `torch.cuda()`â€‹
  - `torch.cuda.is_available()`â€‹ï¼šæ£€æµ‹è®¾å¤‡
- `torch.backends.mps`â€‹

  - `torch.backends.mps.is_available()`â€‹ï¼šæ˜¯å¦å¯ç”¨äº†Metal Performance Shadersï¼ˆMPSï¼‰
  - `torch.backends.mps.is_built()`â€‹ï¼šæ˜¯å¦æ„å»ºäº†MPSæ”¯æŒ

## GPUç›¸å…³

- `!nvdia-smi`â€‹ï¼šæ£€æŸ¥GPUç±»å‹

â€
