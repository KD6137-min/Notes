# CI&CD

# 基本概念

![截屏2025-02-01 17.35.00](../assets/截屏2025-02-01%2017.35.00-20250201173502-psyoswj.png)

- 持续集成: Continuous Integration, CI, 将所有开发者工作副本每天多次合并到主干, 每次集成会经过自动构建(包括自动测试)的检验, 以尽快发现集成错误, 强调提交后立即构建、测试

  - 持续: 长期的对项目代码进行集成
  - 集成: 将孤立事物/元素通过某种方式集中在一起, 产生联系, 从而构成一个有机整体的过程

  ![截屏2025-02-01 17.39.05](../assets/截屏2025-02-01%2017.39.05-20250201173909-lyflu0g.png)
- 持续交付: Continuous Delivery, CD, 完成CI后, 自动将已验证的代码发布到存储库, 目标是拥有一个可随时部署到生产环境的代码库

  - 为实现高效持续交付流程, 务必确保CI已内置于开发管道

  ![截屏2025-02-01 17.45.17](../assets/截屏2025-02-01%2017.45.17-20250201174520-42m5fh4.png)

  - CI服务器将测试结果发送给不同的流程/环境: 先发送给测试环境(Test), 然后将其部署到预发布环境(Staging)进行进一步验证, 用于模拟生产环境的部署, 若无问题, 经手动触发, 代码被推送到生产环境(Production)
- 持续部署: Continuous Deployment, CD, 在持续交付的基础上, 把部署到生产环境的过程自动化, 最后阶段, 持续交付的延伸, 依赖精心设计的测试自动化, 更改在编写后几分钟内即可生效, 便于持续接收和整合用户反馈

  ![截屏2025-02-01 17.55.50](../assets/截屏2025-02-01%2017.55.50-20250201175553-acwb6j1.png)



# 持续集成CI

## 组成要素

- 版本管理系统: 一般用git作为版本控制库, 用github/gitlab/stash作为版本管理软件
- 构建脚本&工具: 实现对整个项目的自动化构建(编译、静态扫描、运行测试、样式检查、打包、发布)
- CI服务器: 检测代码变动, 通过构建机器运行构建脚本, 将集成结果反馈给团队成员

## 工作流

### 瀑布式开发模型

- 参与人员: 开发、项目经理、测试
- 主要流程: 

  - 划分模块并分配给开发人员
  - 开发人员开发好一个模块就进行单元测试
  - 所有的模块都开发完成之后, 由项目经理对所有代码进行集成
  - 集成后的项目由项目经理部署到测试服务器上, 被交由测试人员进行集成测试
  - 测试过程中出现Bug就把问题记录到Bug列表中
  - 项目经理分配Bug给相应的责任人进行修改
  - 修改后, 项目经理再次对项目进行集成, 并部署到测试服务器上
  - 测试人员在下一次的集成测试中进行回归测试
  - 通过通过之后就部署到生产环境中
  - 测试不通过则重复'分配Bug -> 修改Bug -> 集成代码 -> 部署到测试服务器上 -> 集成测试'
- 问题: 

  - 重复性劳动, 无效的等待多
  - 发现缺陷晚, 且难以修复
  - 软件品质低, 交付时无法保障
  - 缺少可见性

### DevOps模型

![截屏2025-02-01 18.13.53](../assets/截屏2025-02-01%2018.13.53-20250201181355-9zjd9e3.png)

1. ﻿﻿开发者检入代码到源代码仓库
2. ﻿﻿﻿CI系统会为每一个项目创建一个单独的工作区, 当预设或请求一次新的构建时, 它将把源代码仓库的源码存放到对应的工作区
3. ﻿﻿﻿CI系统会在对应的工作区内执行构建过程
4. ﻿﻿构建完成后, CI系统会在一个新的构件中执行定义的一套测试, 完成后触发通知(Email,RSS等)给相关的当事人
5. ﻿﻿﻿如果构建成功, 这个构件会被打包并转移到一个部署目标(如应用服务器)或存储为软件仓库中的一个新版本

    - 软件仓库可以是CI系统的一部分, 也可以是一个外部的仓库
6. ﻿﻿﻿CI系统根据请求发起相应的操作, 诸如即时构建、生成报告, 或者检索一些构建好的构件

## 解决的问题

- 高效率: 发布快, 避免重复性劳动, 修复BUG快, 交付快, 等待时间少
- 高质量: 只有在完成集成测试、系统测试的最后时刻才能拿到可运行软件
- 高产出: 可在任何时间发布可部署的软件, 持续对源代码进行小改动

## 最佳实践

- 使测试成为开发过程中不可或缺的一部分, 应在创建代码时编写测试
- 确保测试环境反映生产一致
- 使用编码最佳实践, 如结对编程Pair Programming, 一人编写代码, 一人代码view
- 自动化部署工作流程

## 效率工具对比

![截屏2025-02-01 18.31.54](../assets/截屏2025-02-01%2018.31.54-20250201183157-odvrwg6.png)

### Jenkins

开源持续集成软件

特点: 

- 易安装: Jenkins是一个独立的基于Java的程序(仅一个java-jar jenkins.war), 随时可运行, 包含多种操作系统, 无需额外安装, 无需数据库
- 易配置: 提供友好的GUI配置界面
- 变更支持: 可从代码仓库中获取并产生代码更新列表并输出到编译输出信息中
- 支持永久链接: 用户访问Jenkins的Web界面链接地址为永久链接地址, 可在各种文档中直接使用
- 集成E-Mail/RSS/IM: 完成一次集成时, 可实时告知集成结果
- JUnit/TestNG测试报告: 用图表提供详细的测试报表, 如项目构建的趋势和稳定性
- 支持分布式构建: 可把集成构建工作分发到多台计算机中
- 文件指纹信息: 可保存哪次集成构建产生哪些jars文件, 哪次集成构建使用哪个版本的jars文件的构建记录
- 支持第三方插件: 几乎集成了持续集成和持续交付工具链中的所有工具
- Rest API: 可访问控制获取的数据量, 获取/更新config.xml, 删除作业, 检索所有构建, 获取/更新作业说明, 执行构建, 禁用/启用作业

缺点: 

- 需要专用服务器/多个服务器, 导致额外费用
- 配置/定制需时间

‍

### Travis CI

托管的持续集成服务, 用户构建和测试在GitHub上托管的软件项目, 快速启动, 开源免费, 无需专用服务器, 轻量级YAML配置

特点: 

- 基于云:
- 支持Docker运行测试
- 使用YAML文件进行配置
- 可选择Linux和Mac OSX上同时运行测试
- 开箱即用
- 支持多环境构建矩阵: 可使用不同版本的语言和包运行测试

缺点: 

- 价格高, 无免费的企业计划
- 定制

### Circle CI

持续集成领导者, 每个代码更改都会在干净的容器/VM中触发自动化测试, 可使用并运行所有语言

特点

- 云&本地化: 基于云, 不需专用服务器, 不需管理, 提供本地解决方案, 允许在私有云/数据中心运行
- 商业&免费: 商业账户有免费计划
- Rest API: 可访问项目、构建和工件(artifacts), 构建的结果为工件/工件组, 工件可为已编译的应用程序/可执行文件/元数据
- 按需安装: Circle CI缓存必要的安装, 检查第三方依赖项, 而不是持续安装所需的环境
- SSH模式: 可触发SSH模式访问容器并进行自己的调查
- 最小化配置: 一个完整的开箱即用的解决方案, 需要最少的配置/调整

缺点: 

- 仅支持2个版本的Ubuntu免费和macOS付费部分
- tt仅支持开箱即用的Go、Haskell、Java、PHP、Python、Ruby、Rails、Scala
- 自定义可能出现问题

![截屏2025-02-01 19.26.26](../assets/截屏2025-02-01%2019.26.26-20250201192630-pb32bhj.png)

# Jenkins

## 概念

- 流水线Jenkins Pipeline: 一套可扩展的插件, 将持续交付的实现和实施集成到Jenkins中, 定义通常写入`Jenkinsfile`​中
- 节点: 一个机器, 用于执行Jenkins任务
- 阶段: 定义不同的执行任务
- 步骤: 告诉Jenkins现在做什么

开启: `brew services start jenkins-lts`​

停止: `brew services stop jenkins-lts`​

‍
