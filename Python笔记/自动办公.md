# 操作图像

pillow模块, image类

```python
from PIL import Image, ImageFilter

# 打开图像
image = Image.open('./res/guido.jpg')
# 图像基本信息
print(image.format, image.size, image.mode)
# 显示图像
image.show()

# 剪裁图像
rect = 80, 20, 310, 360
image.crop(rect).show()

# 生成缩略图
size = 128, 128
image.thumbnail(size)

# 缩放和粘贴图像
rect = 80, 20, 310, 360
guido_head = image.crop(rect)
width, height = guido_head.size
# paste方法把一参粘贴到对象中, 位置为二参
# resize方法参数为元组类型
image.paste(guido_head.resize((int(width/1.5), int(height/1.5))), (172, 40))

# 旋转
image.rotate(180).show()
# 翻转
image.transpose(Image.FLIP_LEFT_RIGHT).show()

# 操作像素
# putpixel方法, 在一参指定位置放置二参指定颜色的像素点
for x in range(80, 310):
	for y in range(20, 360):
		image.putpixel((x, y), (128, 128, 128))

# 滤镜效果
image.filter(ImageFilter.CONTOUR).show()
```

# 操作短信

使用互亿无线短信平台提供的API接口, 实现发送短信

```python
import urllib.parse
import http.client
import json


def main():
    host  = "106.ihuyi.com"
    sms_send_uri = "/webservice/sms.php?method=Submit"
    # 下面的参数需要填入自己注册的账号和对应的密码
    params = urllib.parse.urlencode({
		'account': '你自己的账号', 
		'password': '你自己的密码', 
		'content': '您的验证码是: 147258, 请不要把验证码泄露给其他人, ', 
		'mobile': '接收者的手机号', 'format':'json' 
	})
    print(params)
    headers = {
		'Content-type': 'application/x-www-form-urlencoded', 
		'Accept': 'text/plain'
	}
    conn = http.client.HTTPConnection(host, port=80, timeout=30)
    conn.request('POST', sms_send_uri, params, headers)
    response = conn.getresponse()
    response_str = response.read()
    jsonstr = response_str.decode('utf-8')
    print(json.loads(jsonstr))
    conn.close()


if __name__ == '__main__':
    main()
```

# 操作文档

docx模块, Document类

Document: 一个文档

Paragraph: 文档中一个段落

Run: 段落中的文字块, 颜色、字体、粗细、斜体不同即为不同的文字块

```python
from docx import Document
from docx.shared import Inches,Cm 	# 英寸单位和厘米

# 创建document对象
document = Document()
# 添加标题
document.add_heading('Document Title', 0)
# 添加段落
p = document.add_paragraph('A plain paragraph having some ')

# 加粗
p.add_run('bold').bold = True
# 加文字块
p.add_run(' and some ')
# 斜体
p.add_run('italic.').italic = True

# 添加1级标题
document.add_heading('l1', level=1)

# 无序列表
document.add_paragraph(
	'first item in unordered list', 
	style='List Bullet'
)
# 有序列表
document.add_paragraph(
	'first item in ordered list', 
	style='List Number'
)

# 引用格式
document.add_paragraph('Intense quote', style='Intense Quote')

# 添加图片
document.add_picture('monty-truth.png', width=Inches(1.25))

records = (
	(3, 3, 3), 
	(4, 4, 4), 
	(5, 5, 5)
)
# 添加表格
table = document.add_table(rows=1, cols=3)
hdr_cells = table.rows[0].cells
# 列名
hdr_cells[0].text = 'Qty'
hdr_cells[1].text = 'Id'
hdr_cells[2].text = 'Desc'
# 动态添加数据行
for qty, id, desc in records:
	row_cells = table.add_row().cells
	row_cells[0].text = str(qty)
	row_cells[1].text = str(id)
	row_cells[2].text = str(desc)

# 添加分页符
document.add_page_break()
# 保存文档
document.save('demo.docx')
```

# ‍操作邮件

- smtplib: 连接服务器, 授权认证身份, 发送邮件

    - smtp.qq.com smtp.163.com, 端口号为465
- email: 构造邮件的库

## 导包

```python
import smtplib
from email.mime.multipart import MIMEMultipart 构造邮件
from email.mime.text import MIMEText 构造正文
from email.mime.application import MIMEApplication 构造附件
from email.mime.image import MIMEImage 构造图片
```

## 数据准备

```python
sender = '17731959391@163.com'  
receiver='13231808957@163.com' 
```

- 人不同, 信息相同: 

    ```python
    receivers = ['', '', ……]
    email['To'] = ','.join(receivers) 		# 需用逗号连接各收件人
    ```

- 人不同, 信息不同: 字典形式

    ```python
    receivers = {
    	{'邮箱': '15612383765@163.com', '主题': '人生苦短', '内容': '人生苦短, 我用Python'}, 
    	{'邮箱': '11413565321@qq.com', '主题': '邮件练习', '内容': '你学废了吗'}
    }
    
    for receiver in receivers:
    	email = MIMEMultipart()
    	email['From'] = sender
    	email['To'] = receiver['邮箱']
    	email['Subject'] = receiver['主题']
    ```

## 构造邮件

- `email = MIMEMultipart()`: 设置邮件的头部信息, 键值对形式

    ```python
    email['From'] = '发件人'
    email['To'] = '收件人'
    email['Subject'] = '主题'
    ```

- `text = MIMEText()`: 构造正文

    - `_text`: 设置正文的内容

        ```python
        file = open('./Week2_day4_作业.html', 'r', encoding='utf-8') 
        data = file.read()
        file.close()
        ```

    - `_subtype='plain'`: 正文的格式

        - plain: 纯文本
        - html: 超文本

    - `_charset=None`​或`'utf-8'`: 内容编码方式

    - `email.attach(text)`​

- `app = MIMEApplication()`: 构造附件

    - `_data=app_data`: 准备data

        ```python
        app = open('./img.png', 'rb') 		# 图片、音视频用rb, 不用encoding
        app_data = app.read() 
        app.close()
        ```

    - `app.add_header()`​

        - `_name:'content-disposition'`: 附件内容排列设置信息
        - `_value:'attachment'`: 依附形式的 必须依附于邮件
        - `filename='文件名'`: 邮件中展示附件的名称, 不能包含中文

    - `email.attach(app)`​

- `img = MIMEImage()`: 构造图片

    ```python
    pic = open('./homework.jpg', 'rb')
    image_data = pic.read() 
    pic.close()
    ```

## 发送邮件

- `connect = smtp.SMTP-SSL()`: 连接服务器

    - host\=服务器地址或者域名, port\=端口号

- `connect.login()`: 授权认证

    - user用户名, password授权码

- `connect.sendmail()`: 发送

    - from\_addr发件人

    - to\_addrs收件人, 可以是列表

    - msg待发送的邮件(需要转换成字符串)

        ```python
        connect.sendmail(
        	from_addr='1114354656@qq.com', 
        	to_addrs='15650726528@163.com', 
        	msg=email.as_string( )
        )
        ```

- `connect.close()`: 断开连接

## schedule定时发送邮件

- `import schedule`: 导包
- `def send_email(receiver, subject, file_path, subtype)`: 构造函数
- `schedule.every(interval=10).seconds.do(send_email,*args)`: 传入参数

    - interval为间隔时间, seconds可替换为day、hour、Monday等, do()中为要定时执行的操作
- `while True:  schedule.run_pending()`: 程序要一直开着

## 示例

- 完整版:

    ```python
    # 导包
    import smtplib
    from email.mime.multipart import MIMEMultipart
    from email.mime.text import MIMEText
    from email.mime.image import MIMEImage
    from email.mime.application import MIMEApplication
    
    # 数据准备
    sender = '17731959391@163.com'
    receiver = '1234855843@qq.com'
    
    # 构造邮件 	# 给多人 for i in receivers:
    email = MIMEMultipart()
    email['From'] = sender
    email['To'] = receiver 	# 给多人列表','.join(receivers), 给多人字典i['email']
    email['Subject'] = 'week2作业'
    
    # 构造正文
    file = open('./weekfs.html', 'r', encoding='utf=8')
    data = file.read() 	# 多人时需对data进行填充 data = data%(i['name'], i['BS'], ……)
    file.close()
    text = MIMEText(_text=data, _subtype='html', _charset='utf-8')
    email.attach(text)
    
    # 构造图片
    pic = open('./homework.jpg', 'rb')
    image_data = pic.read()
    pic.close()
    image = MIMEImage(_imagedata=image_data, _subtype=None)
    image.add_header('Content-ID', 'homework')
    email.attach(image)
    
    # 构造附件
    file = open('./img.png', 'rb')
    app_data = file.read()
    file.close()
    app = MIMEApplication(_data=app_data)
    app.add_header('content-disposition', 'attachment', filename='img.png')
    email.attach(app)
    
    # 发送邮件
    connect = smtplib.SMTP_SSL(host='smtp.163.com', port=465)
    connect.login(user=sender, password='YVTUBINTRYFTUY')
    connect.sendmail(from_addr=sender, to_addr=receiver, msg=email.as_string()) # 多人情况下to_addrs=i['email']
    connect.close()
    ```

- 简单版: 

    ```python
    from smtplib import SMTP
    from email.header import Header
    from email.mime.text import MIMEText
    
    def main():
        # 请自行修改下面的邮件发送者和接收者
        sender = 'abcdefg@126.com'
        receivers = ['uvwxyz@qq.com', 'uvwxyz@126.com']
        message = MIMEText('用Python发送邮件的示例代码.', 'plain', 'utf-8')
        message['From'] = Header('王大锤', 'utf-8')
        message['To'] = Header('骆昊', 'utf-8')
        message['Subject'] = Header('示例代码实验邮件', 'utf-8')
        smtper = SMTP('smtp.126.com')
        # 请自行修改下面的登录口令
        smtper.login(sender, 'secretpass')
        smtper.sendmail(sender, receivers, message.as_string())
        print('邮件发送完成!')
    
    
        if __name__ == '__main__':
            main()
    ```

 - 改进版: 

    ```python
    import smtplib
    from email.mime.multipart import MIMEMultipart
    from email.mime.text import MIMEText
    from email.mime.image import MIMEImage
    from email.mime.application import MIMEApplication
    
    
    def send_email(sender, password, receivers, subject, text_body=None, html_body=None, attachments=None, images=None):
        """
        发送邮件的通用函数
        :param sender: 发件人邮箱
        :param password: 发件人授权码
        :param receivers: 收件人列表
        :param subject: 邮件主题
        :param text_body: 文本内容(纯文本)
        :param html_body: HTML内容(优先显示)
        :param attachments: 附件列表, 每项为文件路径
        :param images: 嵌入图片列表, 每项为文件路径
        """
        email = MIMEMultipart()
        email['From'] = sender
        email['To'] = ', '.join(receivers)
        email['Subject'] = subject
    
        # 添加文本或HTML正文
        if text_body:
            email.attach(MIMEText(text_body, 'plain', 'utf-8'))
        if html_body:
            email.attach(MIMEText(html_body, 'html', 'utf-8'))
    
        # 添加附件
        if attachments:
            for file_path in attachments:
                with open(file_path, 'rb') as f:
                    app = MIMEApplication(f.read())
                    app.add_header('Content-Disposition', 'attachment', filename=file_path.split('/')[-1])
                    email.attach(app)
    
        # 添加嵌入图片
        if images:
            for idx, image_path in enumerate(images):
                with open(image_path, 'rb') as img:
                    image = MIMEImage(img.read())
                    image.add_header('Content-ID', f'<image_{idx}>')
                    email.attach(image)
    
        # 发送邮件
        try:
            with smtplib.SMTP_SSL(host='smtp.163.com', port=465) as server:
                server.login(sender, password)
                server.sendmail(sender, receivers, email.as_string())
                print("邮件发送成功")
        except Exception as e:
            print(f"发送失败: {e}")
    
    
        # 示例调用
        if __name__ == '__main__':
            send_email(
                sender='your_email@163.com',
                password='your_password',
                receivers=['receiver1@qq.com', 'receiver2@qq.com'],
                subject='Test Email',
                text_body='This is a test email.',
                html_body='<h1>HTML Content</h1><img src="cid:image_0">',
                attachments=['/path/to/attachment1.txt', '/path/to/attachment2.xlsx'],
                images=['/path/to/image.jpg']
            )
    ```

# 操作Excel

## 管理

- 导包: `import openpyxl`​

- 创建新工作簿对象: `wb = openpyxl.Workbook()`​, 注意 W 大写, 后面有圆括号
- 新建工作表: `ws1 = wb.create_sheet(title, index)`​, 可指定表名和位置
- 选中切换到要操作的工作表(必须先选中才能操作), 两种方式: 

    - `ws = wb['Sheet']`​
    - `ws = wb.active`​
- 加载现有的工作簿: `wb = openpyxl.load_workbook(filename)`​
- 保存工作簿: `wb.save(filename)`​

## 增

- 以单元格添加

    - `ws2.cell(6,6).value = '晴天'`​

    - `ws2.cell(行, 列, 数据)`​

        - 可使用循环添加数据

            ```python
            data = ['学号', '姓名', '年龄', '性别', '班级编号'] 
            for i in range(len(data)): 
            	ws.cell(1, i+1, titles[i])
            # 或者
            data = [( ), ( ), ( )……] 
            for row, data1 in enumerate(data, start=1): 
            	for col, ele in enumerate(data1, start=1): 
            		ws.cell(row, col, ele)
            ```

- 以行添加: `ws2.append(['编号',  '班级名称', ……])`​, 必须为序列形式, 默认在原有数据的下一行添加

> excel的行列是从1开始的, 区别于下标

## 查

- 获取所有工作表的名称: `print(wb.sheetnames)`​

- 获取单元格数据: `print(cell.value)`​

    - 使用循环获取所有数据

        ```python
        for row_data in ws.rows: 
        	print(row_data) 
        	for cell in row_data: 
        		print(cell.value, end='\t') 
        	print( )
        ```

- 总行数: `print(ws.max_row)`​

- 总列数: `print(ws.max_column)`​

## 改

- 修改工作表的名称: `ws.title = '新的名称'`​

- 合并excel

    ```python
    # 准备接受数据
    new_workbook = openpyxl.Workbook()
    new_sheet = new_workbook['Sheet']  
    
    # 获取每一张表
    for pos in range(len(data_workbook.sheetnames)): 
    	sheet_name = data_workbook.sheetnames[pos]  
    	sheet = data_workbook[sheet_name]
    
    # 合并数据
    rows = list(sheet.rows)  
    if pos != 0: 
    	rows = rows[1:]  # 非第一张表则去除表头 
    for row_data in rows: 
    	cell_datas = [cell.value for cell in row_data] 
    	new_sheet.append(cell_datas)
    
    # 保存
    new_workbook.save('./数据整合版.xlsx')
    ```

- 合并文件夹下各文件的数据

    ```python
    # 导包, 构造工作簿、工作表
    import os 
    import openpyxl 
    new_workbook = openpyxl.Workbook() 
    new_sheet = new_workbook['Sheet']
    
    # 获取路径
    dir_path = './各省数据' 
    filenames = os.listdir(dir_path)
    # 路径拼接
    for index in range(len(filenames)): 
    	fn = filenames[index]   
    	join_path = os.path.join(dir_path, fn) 
    	data_workbook = openpyxl.load_workbook(join_path)
    
    # 获取每一张工作表
    sheet_name = data_workbook.sheetnames[0]   
    data_sheet = data_workbook[sheet_name] 		# 此处保留了第一张表的名称
    
    # 遍历获取每一行
    rows = list(data_sheet.rows) 
    if index != 0:
    	rows = rows[1:] 
    for row_data in rows: 
    	cell_datas = [cell.value for cell in row_data] 
    	new_sheet.append(cell_datas)
    
    # 保存
    new_workbook.save('./合并.xlsx')
    ```
